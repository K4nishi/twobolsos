<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Finance SaaS V8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: sans-serif; }
        .card-negocio { background: #161b22; border: 1px solid #30363d; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .card-negocio:hover { border-color: #58a6ff; transform: translateY(-3px); }
        .text-lucro { color: #3fb950; }
        .text-preju { color: #f85149; }
        .kpi-box { background: #161b22; border: 1px solid #30363d; padding: 15px; border-radius: 6px; text-align: center; }
        .badge-receita { background-color: rgba(63, 185, 80, 0.2); color: #3fb950; border: 1px solid #3fb950; }
        .badge-despesa { background-color: rgba(248, 81, 73, 0.2); color: #f85149; border: 1px solid #f85149; }
        .nav-pills .nav-link.active { background-color: #30363d; border-color: #8b949e; }
        .nav-pills .nav-link { color: #8b949e; }
    </style>
</head>
<body class="p-4">

    <div id="viewHome" class="container">
        <div class="d-flex justify-content-between mb-4">
            <h3>Minhas Carteiras</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovo">+ Novo Negócio</button>
        </div>
        <div id="listaNegocios" class="row g-3"></div>
    </div>

    <div id="viewDash" class="container" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary">
            <div class="d-flex align-items-center gap-3">
                <button onclick="voltarHome()" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i></button>
                <div>
                    <h3 class="mb-0 d-inline" id="dashTitle">Nome</h3>
                    <span class="badge bg-secondary ms-2" id="dashTipo">TIPO</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button onclick="abrirModalFixas()" class="btn btn-outline-warning btn-sm"><i class="bi bi-calendar-check"></i> Fixas</button>
                <button onclick="deletarNegocio()" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></button>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-4"><div class="kpi-box"><small>Entradas</small><h4 class="text-lucro" id="valRec">R$ 0</h4></div></div>
            <div class="col-4"><div class="kpi-box"><small>Saídas</small><h4 class="text-preju" id="valDesp">R$ 0</h4></div></div>
            <div class="col-4"><div class="kpi-box"><small>Saldo</small><h4 class="text-white" id="valSaldo">R$ 0</h4></div></div>
        </div>

        <div id="painelMotorista" class="row g-3 mb-4" style="display:none;">
            <div class="col-12"><h6 class="text-secondary border-bottom border-secondary pb-1 small">RODAGEM</h6></div>
            <div class="col-6"><div class="kpi-box"><i class="bi bi-speedometer2 text-warning"></i><h4 id="valKm">0 km</h4></div></div>
            <div class="col-6"><div class="kpi-box"><i class="bi bi-fuel-pump text-danger"></i><h4 id="valLitros">0 L</h4></div></div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-8">
                <div class="kpi-box h-100 p-2"><canvas id="graficoSemanal" style="max-height: 250px;"></canvas></div>
            </div>
            <div class="col-md-4 d-flex flex-column gap-2">
                <button onclick="abrirModalTrans('receita')" class="btn btn-success h-50 fs-5">Nova Receita</button>
                <button onclick="abrirModalTrans('despesa')" class="btn btn-danger h-50 fs-5">Nova Despesa</button>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Histórico</h5>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary active" onclick="filtrarExtrato('todos', this)">Todos</button>
                <button type="button" class="btn btn-outline-success" onclick="filtrarExtrato('receita', this)">Entradas</button>
                <button type="button" class="btn btn-outline-danger" onclick="filtrarExtrato('despesa', this)">Saídas</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead id="tabelaHead"></thead>
                <tbody id="tabelaBody"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modalNovo" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content bg-dark border-secondary"><div class="modal-body">
            <h5>Criar Carteira</h5>
            <input id="nNome" class="form-control bg-dark text-white mb-2" placeholder="Nome">
            <select id="nTipo" class="form-select bg-dark text-white mb-3">
                <option value="PADRAO">Padrão</option>
                <option value="MOTORISTA">Motorista de App</option>
            </select>
            <input id="nCor" type="color" class="form-control mb-3" value="#0d6efd">
            <button onclick="criarNegocio()" class="btn btn-primary w-100">Criar</button>
        </div></div></div>
    </div>

    <div class="modal fade" id="modalTrans" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content bg-dark border-secondary"><div class="modal-body">
            <h5 id="transTitulo">...</h5>
            <input type="hidden" id="tTipo">
            <input id="tDesc" class="form-control bg-dark text-white mb-2" placeholder="Descrição">
            <input id="tVal" type="number" class="form-control bg-dark text-white mb-2" placeholder="Valor (R$)">
            <input id="tData" type="date" class="form-control bg-dark text-white mb-3">
            <div id="inputsDriver" style="display:none;" class="p-2 border border-secondary rounded mb-3">
                <input id="tKm" type="number" class="form-control bg-dark text-white border-warning mb-2" placeholder="KM Rodado">
                <input id="tLitros" type="number" class="form-control bg-dark text-white border-danger" placeholder="Litros">
            </div>
            <button onclick="salvarTrans()" class="btn btn-primary w-100">Salvar</button>
        </div></div></div>
    </div>

    <div class="modal fade" id="modalFixas" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content bg-dark border-secondary"><div class="modal-body">
            <h5>Gerenciar Contas Fixas</h5>
            <div class="input-group mb-3">
                <input id="fNome" class="form-control bg-dark text-white" placeholder="Nome (Ex: Facul)">
                <input id="fValor" type="number" class="form-control bg-dark text-white" placeholder="R$">
                <button onclick="criarFixa()" class="btn btn-primary">Add</button>
            </div>
            <ul id="listaFixas" class="list-group list-group-flush bg-dark rounded"></ul>
        </div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = "http://127.0.0.1:8000";
        let ATUAL_ID = null;
        let ATUAL_CATEGORIA = null;
        let CACHE_DADOS = null; // Guarda os dados para filtrar sem ir no servidor
        let CHART = null;

        document.getElementById('tData').valueAsDate = new Date();

        // --- HOME ---
        async function carregarHome() {
            document.getElementById('viewHome').style.display='block';
            document.getElementById('viewDash').style.display='none';
            const res = await fetch(`${API}/negocios`);
            const lista = await res.json();
            const div = document.getElementById('listaNegocios');
            div.innerHTML = "";
            lista.forEach(n => {
                div.innerHTML += `
                    <div class="col-md-4">
                        <div class="card-negocio p-3" onclick="abrirDash(${n.id})" style="border-left: 5px solid ${n.cor}">
                            <div class="d-flex justify-content-between"><h5 class="fw-bold">${n.nome}</h5><span class="badge bg-secondary">${n.categoria}</span></div>
                            <h3 class="mt-3 ${n.saldo>=0?'text-lucro':'text-preju'}">R$ ${n.saldo.toFixed(2)}</h3>
                        </div>
                    </div>`;
            });
        }

        async function criarNegocio() {
            await fetch(`${API}/negocios`, {method:"POST", headers:{"Content-Type":"application/json"}, 
                body: JSON.stringify({nome:document.getElementById('nNome').value, categoria:document.getElementById('nTipo').value, cor:document.getElementById('nCor').value})});
            bootstrap.Modal.getInstance(document.getElementById('modalNovo')).hide();
            carregarHome();
        }

        // --- DASHBOARD ---
        async function abrirDash(id) {
            ATUAL_ID = id;
            document.getElementById('viewHome').style.display='none';
            document.getElementById('viewDash').style.display='block';
            await atualizarTela();
        }

        async function atualizarTela() {
            const res = await fetch(`${API}/negocios/${ATUAL_ID}/dashboard`);
            CACHE_DADOS = await res.json(); // Salva no Cache Global
            const n = CACHE_DADOS.negocio;
            ATUAL_CATEGORIA = n.categoria;

            // UI Geral
            document.getElementById('dashTitle').innerText = n.nome;
            document.getElementById('dashTipo').innerText = n.categoria;
            document.getElementById('valRec').innerText = `R$ ${CACHE_DADOS.kpis.receita.toFixed(2)}`;
            document.getElementById('valDesp').innerText = `R$ ${CACHE_DADOS.kpis.despesa.toFixed(2)}`;
            document.getElementById('valSaldo').innerText = `R$ ${CACHE_DADOS.kpis.saldo.toFixed(2)}`;

            // Motorista
            const pMot = document.getElementById('painelMotorista');
            if(n.categoria==='MOTORISTA') {
                pMot.style.display='flex';
                document.getElementById('valKm').innerText = CACHE_DADOS.kpis.total_km + " km";
                document.getElementById('valLitros').innerText = CACHE_DADOS.kpis.total_litros + " L";
            } else { pMot.style.display='none'; }

            // Gráfico
            if(CHART) CHART.destroy();
            const ctx = document.getElementById('graficoSemanal').getContext('2d');
            CHART = new Chart(ctx, {
                type: 'bar',
                data: { labels: CACHE_DADOS.grafico.labels, datasets: [{label:'Entrada', data:CACHE_DADOS.grafico.receitas, backgroundColor:'#3fb950'}, {label:'Saída', data:CACHE_DADOS.grafico.despesas, backgroundColor:'#f85149'}] },
                options: { responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}}, y:{grid:{color:'#30363d'}}} }
            });

            // Renderiza Tabela (Padrão: Todos)
            renderizarTabela(CACHE_DADOS.extrato);
        }

        // --- FILTROS DE TABELA ---
        function filtrarExtrato(tipo, btn) {
            // UI dos botões
            document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            if (tipo === 'todos') {
                renderizarTabela(CACHE_DADOS.extrato);
            } else {
                const filtrado = CACHE_DADOS.extrato.filter(t => t.tipo === tipo);
                renderizarTabela(filtrado);
            }
        }

        function renderizarTabela(lista) {
            const thead = document.getElementById('tabelaHead');
            const tbody = document.getElementById('tabelaBody');
            
            // Header Dinâmico
            let h = `<tr><th>Data</th><th>Tipo</th><th>Descrição</th>`;
            if(ATUAL_CATEGORIA==='MOTORISTA') h += `<th>KM</th><th>Litros</th>`;
            h += `<th class="text-end">Valor</th><th></th></tr>`;
            thead.innerHTML = h;

            // Body
            tbody.innerHTML = "";
            lista.forEach(t => {
                let badge = t.tipo==='receita' ? '<span class="badge badge-receita">Entrada</span>' : '<span class="badge badge-despesa">Saída</span>';
                let row = `<tr><td class="text-secondary small">${t.data}</td><td>${badge}</td><td>${t.descricao}</td>`;
                if(ATUAL_CATEGORIA==='MOTORISTA') {
                    row += `<td class="text-warning small">${t.km>0?t.km:'-'}</td><td class="text-danger small">${t.litros>0?t.litros:'-'}</td>`;
                }
                let cor = t.tipo==='receita'?'text-lucro':'text-preju';
                row += `<td class="text-end fw-bold ${cor}">R$ ${t.valor.toFixed(2)}</td>
                        <td class="text-end"><button onclick="deletarTrans(${t.id})" class="btn btn-sm btn-link text-secondary"><i class="bi bi-x-lg"></i></button></td></tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- TRANSAÇÕES (SEM REFRESH) ---
        function abrirModalTrans(tipo) {
            document.getElementById('tTipo').value = tipo;
            document.getElementById('transTitulo').innerText = tipo === 'receita' ? "Nova Receita" : "Nova Despesa";
            
            const driverInputs = document.getElementById('inputsDriver');
            driverInputs.style.display = 'none'; // Reset
            
            if(ATUAL_CATEGORIA==='MOTORISTA') {
                driverInputs.style.display = 'block';
                // Mostra só o input relevante
                document.getElementById('tKm').style.display = tipo==='receita' ? 'block' : 'none';
                document.getElementById('tLitros').style.display = tipo==='despesa' ? 'block' : 'none';
            }
            new bootstrap.Modal(document.getElementById('modalTrans')).show();
        }

        async function salvarTrans() {
            await fetch(`${API}/transacoes`, {
                method:"POST", headers:{"Content-Type":"application/json"},
                body: JSON.stringify({
                    negocio_id: ATUAL_ID, tipo: document.getElementById('tTipo').value, descricao: document.getElementById('tDesc').value,
                    valor: document.getElementById('tVal').value, data: document.getElementById('tData').value,
                    km: document.getElementById('tKm').value || 0, litros: document.getElementById('tLitros').value || 0
                })
            });
            bootstrap.Modal.getInstance(document.getElementById('modalTrans')).hide();
            // Limpa inputs
            document.getElementById('tDesc').value=""; document.getElementById('tVal').value=""; document.getElementById('tKm').value=""; document.getElementById('tLitros').value="";
            atualizarTela(); // A Mágica: Atualiza sem sair
        }

        async function deletarTrans(id) {
            if(confirm("Apagar?")) { await fetch(`${API}/transacoes/${id}`, {method:"DELETE"}); atualizarTela(); }
        }

        // --- CONTAS FIXAS ---
        function abrirModalFixas() {
            carregarFixas();
            new bootstrap.Modal(document.getElementById('modalFixas')).show();
        }

        async function carregarFixas() {
            const res = await fetch(`${API}/negocios/${ATUAL_ID}/fixas`);
            const lista = await res.json();
            const ul = document.getElementById('listaFixas');
            ul.innerHTML = "";
            lista.forEach(f => {
                ul.innerHTML += `
                    <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center">
                        <span>${f.nome} (R$ ${f.valor})</span>
                        <div>
                            <button onclick="pagarFixa(${f.id})" class="btn btn-sm btn-outline-success" title="Pagar Agora"><i class="bi bi-check-lg"></i> Pagar</button>
                            <button onclick="deletarFixa(${f.id})" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                        </div>
                    </li>`;
            });
        }

        async function criarFixa() {
            await fetch(`${API}/fixas`, {method:"POST", headers:{"Content-Type":"application/json"}, 
                body: JSON.stringify({nome:document.getElementById('fNome').value, valor:document.getElementById('fValor').value, negocio_id:ATUAL_ID})});
            document.getElementById('fNome').value=""; document.getElementById('fValor').value="";
            carregarFixas();
        }

        async function pagarFixa(id) {
            await fetch(`${API}/fixas/${id}/pagar`, {method:"POST"});
            alert("Conta paga! Lançada no extrato.");
            carregarFixas();
            atualizarTela(); // Atualiza saldo lá atrás
        }

        async function deletarFixa(id) {
            await fetch(`${API}/fixas/${id}`, {method:"DELETE"});
            carregarFixas();
        }

        async function deletarNegocio() {
            if(confirm("Apagar carteira inteira?")) { await fetch(`${API}/negocios/${ATUAL_ID}`, {method:"DELETE"}); voltarHome(); }
        }
        function voltarHome() { document.getElementById('viewDash').style.display='none'; carregarHome(); }

        carregarHome();
    </script>
</body>
</html>