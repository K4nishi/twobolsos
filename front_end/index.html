<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Finance SaaS V9</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --bg-body: #09090b; --card-bg: #18181b; --glass-border: rgba(255, 255, 255, 0.08); }
        body { background-color: var(--bg-body); color: #e4e4e7; font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        .glass-card { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; }
        .wallet-card { background: linear-gradient(145deg, #1e1e24, #131316); border-radius: 20px; padding: 24px; border: 1px solid var(--glass-border); cursor: pointer; transition: 0.2s; }
        .wallet-card:active { transform: scale(0.98); }
        .kpi-card { background: #1f1f23; border-radius: 12px; padding: 12px; border: 1px solid var(--glass-border); text-align: center; }
        .kpi-value { font-size: 1.1rem; font-weight: 700; margin-top: 4px; }
        .btn-mobile-lg { padding: 14px; border-radius: 12px; font-weight: 600; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-success-soft { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .btn-danger-soft { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--glass-border); }
        .trans-date { font-size: 0.75rem; color: #71717a; }
        .trans-val { font-weight: 700; font-size: 0.95rem; }
        /* Modal Fullscreen Mobile */
        @media (max-width: 576px) { .modal-dialog { margin: 0; } .modal-content { border-radius: 0; min-height: 100vh; border: none; } }
    </style>
</head>
<body>

    <div id="viewHome" class="container py-4 fade-in">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h4 class="fw-bold mb-0">Suas Carteiras</h4><small class="text-secondary">Visão Geral</small></div>
            <button class="btn btn-primary rounded-circle" style="width: 45px; height: 45px;" data-bs-toggle="modal" data-bs-target="#modalNovo"><i class="bi bi-plus-lg"></i></button>
        </div>
        <div id="listaNegocios" class="row g-3"></div>
    </div>

    <div id="viewDash" class="container py-3" style="display: none;">
        <div class="d-flex align-items-center gap-3 mb-4">
            <button onclick="voltarHome()" class="btn btn-outline-secondary rounded-circle" style="width: 40px; height: 40px;"><i class="bi bi-arrow-left"></i></button>
            <div class="flex-grow-1"><h5 class="mb-0 fw-bold" id="dashTitle">...</h5><span class="badge bg-dark border border-secondary text-secondary" id="dashCategoria">...</span></div>
            <button onclick="abrirConfig()" class="btn btn-dark rounded-circle border-secondary"><i class="bi bi-gear"></i></button>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-4"><div class="kpi-card border-success border-opacity-25"><div class="text-success small">Entrou</div><div class="kpi-value text-success" id="valRec">R$0</div></div></div>
            <div class="col-4"><div class="kpi-card border-danger border-opacity-25"><div class="text-danger small">Saiu</div><div class="kpi-value text-danger" id="valDesp">R$0</div></div></div>
            <div class="col-4"><div class="kpi-card"><div class="small">Saldo</div><div class="kpi-value text-white" id="valSaldo">R$0</div></div></div>
        </div>

        <div id="painelMotorista" class="glass-card p-3 mb-3" style="display:none;">
            <div class="d-flex justify-content-between mb-2"><small class="text-secondary fw-bold"><i class="bi bi-speedometer2"></i> RODAGEM</small></div>
            <div class="row g-2">
                <div class="col-6 text-center border-end border-secondary"><h5 class="mb-0 text-warning" id="valKm">0</h5><small class="text-muted" style="font-size:0.7rem">KM TOTAL</small></div>
                <div class="col-6 text-center"><h5 class="mb-0 text-danger" id="valLitros">0</h5><small class="text-muted" style="font-size:0.7rem">LITROS</small></div>
            </div>
        </div>

        <div class="glass-card p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-secondary small mb-0">Fluxo de Caixa</h6>
                <select id="chartDays" onchange="atualizarTela()" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: auto; font-size: 0.8rem;">
                    <option value="7">7 Dias</option>
                    <option value="15">15 Dias</option>
                    <option value="30">30 Dias</option>
                </select>
            </div>
            <div style="height: 180px;"><canvas id="graficoSemanal"></canvas></div>
        </div>

        <div class="row g-2 mb-4">
            <div class="col-6"><button onclick="abrirModalTrans('receita')" class="btn btn-mobile-lg btn-success-soft"><i class="bi bi-arrow-up-circle-fill"></i> Entrada</button></div>
            <div class="col-6"><button onclick="abrirModalTrans('despesa')" class="btn btn-mobile-lg btn-danger-soft"><i class="bi bi-arrow-down-circle-fill"></i> Saída</button></div>
        </div>

        <div class="d-flex justify-content-between align-items-end mb-2">
            <h6 class="text-white mb-0">Histórico</h6>
            <div class="btn-group btn-group-sm">
                <button onclick="filtrar('todos')" class="btn btn-outline-secondary active btn-filter" data-f="todos">T</button>
                <button onclick="filtrar('receita')" class="btn btn-outline-secondary btn-filter" data-f="receita"><i class="bi bi-arrow-up"></i></button>
                <button onclick="filtrar('despesa')" class="btn btn-outline-secondary btn-filter" data-f="despesa"><i class="bi bi-arrow-down"></i></button>
            </div>
        </div>
        <div class="glass-card px-3 py-1" id="listaHistorico"></div>
    </div>

    <div class="modal fade" id="modalNovo" tabindex="-1"><div class="modal-dialog modal-fullscreen-sm-down"><div class="modal-content bg-dark"><div class="modal-header border-secondary"><h5 class="modal-title">Nova Carteira</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <label class="text-secondary small">Nome</label><input id="nNome" class="form-control bg-dark text-white border-secondary mb-3 py-3" placeholder="Ex: Mottu...">
        <label class="text-secondary small">Tipo</label><select id="nTipo" class="form-select bg-dark text-white border-secondary mb-3 py-3"><option value="PADRAO">Padrão</option><option value="MOTORISTA">Motorista de App</option></select>
        <label class="text-secondary small">Cor</label><input id="nCor" type="color" class="form-control form-control-color bg-dark border-secondary w-100 mb-4" value="#3b82f6">
        <button onclick="criarNegocio()" class="btn btn-primary btn-lg w-100">Criar Carteira</button>
    </div></div></div></div>

    <div class="modal fade" id="modalTrans" tabindex="-1"><div class="modal-dialog modal-fullscreen-sm-down"><div class="modal-content bg-dark"><div class="modal-header border-secondary"><h5 class="modal-title" id="transTitulo">Nova Movimentação</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <input type="hidden" id="tTipo">
        <label class="text-secondary small">Valor</label><div class="input-group mb-3"><span class="input-group-text bg-secondary border-secondary text-white">R$</span><input id="tVal" type="number" class="form-control bg-dark text-white border-secondary py-3 fs-5 fw-bold" placeholder="0.00" inputmode="decimal"></div>
        <label class="text-secondary small">Descrição</label><input id="tDesc" class="form-control bg-dark text-white border-secondary mb-3 py-3" placeholder="Ex: Gasolina...">
        <label class="text-secondary small">Data</label><input id="tData" type="date" class="form-control bg-dark text-white border-secondary mb-3 py-3">
        <div id="inputsDriver" class="p-3 mb-4 rounded border border-secondary bg-black bg-opacity-25" style="display:none;">
            <div id="divKm" class="mb-3"><label class="text-warning small fw-bold">KM RODADO</label><input id="tKm" type="number" class="form-control bg-dark text-white border-warning py-2" placeholder="0"></div>
            <div id="divLitros"><label class="text-danger small fw-bold">LITROS ABASTECIDOS</label><input id="tLitros" type="number" class="form-control bg-dark text-white border-danger py-2" placeholder="0"></div>
        </div>
        <button onclick="salvarTrans()" class="btn btn-primary btn-lg w-100">Salvar</button>
    </div></div></div></div>

    <div class="modal fade" id="modalConfig" tabindex="-1"><div class="modal-dialog modal-fullscreen-sm-down"><div class="modal-content bg-dark"><div class="modal-header border-secondary"><h5 class="modal-title">Configurações</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <h6 class="text-white mb-3">Fixas</h6><div class="input-group mb-3"><input id="fNome" class="form-control bg-dark text-white border-secondary" placeholder="Nome"><input id="fValor" type="number" class="form-control bg-dark text-white border-secondary" placeholder="R$"><button onclick="criarFixa()" class="btn btn-outline-light"><i class="bi bi-plus-lg"></i></button></div><ul id="listaFixas" class="list-group list-group-flush rounded mb-5 border border-secondary"></ul>
        <h6 class="text-danger mb-3">Zona de Perigo</h6><button onclick="deletarNegocio()" class="btn btn-outline-danger w-100 py-3"><i class="bi bi-trash"></i> Excluir Carteira</button>
    </div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = "http://127.0.0.1:8000";
        let ATUAL_ID = null;
        let ATUAL_TIPO = null;
        let CACHE_DATA = null;
        let CHART = null;

        document.getElementById('tData').valueAsDate = new Date();

        async function carregarHome() {
            document.getElementById('viewHome').style.display='block';
            document.getElementById('viewDash').style.display='none';
            try {
                const res = await fetch(`${API}/negocios`);
                const lista = await res.json();
                const div = document.getElementById('listaNegocios');
                div.innerHTML = "";
                if(lista.length === 0) div.innerHTML = "<div class='text-center text-muted mt-5'>Nenhuma carteira.<br>Crie uma no botão +</div>";
                lista.forEach(n => {
                    div.innerHTML += `
                        <div class="col-md-6 col-lg-4">
                            <div class="wallet-card" style="--wallet-color: ${n.cor}" onclick="abrirDash(${n.id})">
                                <div class="d-flex justify-content-between align-items-center mb-2"><h5 class="fw-bold mb-0">${n.nome}</h5><span class="badge bg-dark border border-secondary text-secondary">${n.categoria}</span></div>
                                <h2 class="mb-0 ${n.saldo>=0?'text-success':'text-danger'}">R$ ${n.saldo.toFixed(2)}</h2>
                            </div>
                        </div>`;
                });
            } catch (e) { console.error(e); }
        }

        async function criarNegocio() {
            await fetch(`${API}/negocios`, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({nome: document.getElementById('nNome').value, categoria: document.getElementById('nTipo').value, cor: document.getElementById('nCor').value})});
            bootstrap.Modal.getInstance(document.getElementById('modalNovo')).hide();
            carregarHome();
        }

        async function abrirDash(id) {
            ATUAL_ID = id;
            document.getElementById('viewHome').style.display='none';
            document.getElementById('viewDash').style.display='block';
            await atualizarTela();
        }

        async function atualizarTela() {
            // PEGA O VALOR DOS DIAS SELECIONADOS
            const dias = document.getElementById('chartDays').value;
            
            const res = await fetch(`${API}/negocios/${ATUAL_ID}/dashboard?dias=${dias}`);
            CACHE_DATA = await res.json();
            const n = CACHE_DATA.negocio;
            ATUAL_TIPO = n.categoria;

            document.getElementById('dashTitle').innerText = n.nome;
            document.getElementById('dashCategoria').innerText = n.categoria;
            document.getElementById('valRec').innerText = `R$ ${CACHE_DATA.kpis.receita.toFixed(0)}`;
            document.getElementById('valDesp').innerText = `R$ ${CACHE_DATA.kpis.despesa.toFixed(0)}`;
            document.getElementById('valSaldo').innerText = `R$ ${CACHE_DATA.kpis.saldo.toFixed(2)}`;

            const pMot = document.getElementById('painelMotorista');
            if(n.categoria === 'MOTORISTA') {
                pMot.style.display='block';
                document.getElementById('valKm').innerText = CACHE_DATA.kpis.total_km;
                document.getElementById('valLitros').innerText = CACHE_DATA.kpis.total_litros;
            } else { pMot.style.display='none'; }

            renderChart(CACHE_DATA.grafico);
            renderLista(CACHE_DATA.extrato);
        }

        function renderChart(dados) {
            const ctx = document.getElementById('graficoSemanal').getContext('2d');
            if(CHART) CHART.destroy();
            CHART = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dados.labels,
                    datasets: [
                        { label:'Entrada', data:dados.receitas, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)', fill:true, tension:0.4 },
                        { label:'Saída', data:dados.despesas, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.1)', fill:true, tension:0.4 }
                    ]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
            });
        }

        function filtrar(tipo) {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            event.target.closest('button').classList.add('active');
            if(tipo === 'todos') renderLista(CACHE_DATA.extrato);
            else renderLista(CACHE_DATA.extrato.filter(t => t.tipo === tipo));
        }

        function renderLista(lista) {
            const div = document.getElementById('listaHistorico');
            div.innerHTML = "";
            if(lista.length === 0) div.innerHTML = "<div class='text-center py-3 text-secondary small'>Sem registros</div>";
            lista.forEach(t => {
                let icone = t.tipo==='receita' ? '<i class="bi bi-arrow-up-right-circle-fill text-success fs-4"></i>' : '<i class="bi bi-arrow-down-left-circle-fill text-danger fs-4"></i>';
                let corVal = t.tipo==='receita' ? 'text-success' : 'text-danger';
                let extraInfo = (ATUAL_TIPO==='MOTORISTA' && t.km > 0) ? `<span class="badge bg-warning text-dark ms-2">${t.km}km</span>` : '';
                div.innerHTML += `
                    <div class="transaction-item">
                        <div class="d-flex align-items-center gap-3">
                            ${icone}
                            <div><div class="trans-desc text-white">${t.descricao} ${extraInfo}</div><div class="trans-date">${t.data}</div></div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="trans-val ${corVal}">R$ ${t.valor.toFixed(2)}</div>
                            <button onclick="delTrans(${t.id})" class="btn btn-sm text-secondary"><i class="bi bi-x"></i></button>
                        </div>
                    </div>`;
            });
        }

        function abrirModalTrans(tipo) {
            document.getElementById('tTipo').value = tipo;
            document.getElementById('transTitulo').innerText = tipo === 'receita' ? "Entrada" : "Saída";
            document.getElementById('inputsDriver').style.display = 'none';
            if(ATUAL_TIPO === 'MOTORISTA') {
                document.getElementById('inputsDriver').style.display = 'block';
                document.getElementById('divKm').style.display = tipo==='receita'?'block':'none';
                document.getElementById('divLitros').style.display = tipo==='despesa'?'block':'none';
            }
            new bootstrap.Modal(document.getElementById('modalTrans')).show();
        }

        async function salvarTrans() {
            const desc = document.getElementById('tDesc').value; const val = document.getElementById('tVal').value;
            if(!desc || !val) return alert("Preencha valor e descrição");
            await fetch(`${API}/transacoes`, {method:"POST", headers:{"Content-Type":"application/json"},
                body: JSON.stringify({negocio_id: ATUAL_ID, tipo: document.getElementById('tTipo').value, descricao: desc, valor: val, data: document.getElementById('tData').value, km: document.getElementById('tKm').value || 0, litros: document.getElementById('tLitros').value || 0})});
            bootstrap.Modal.getInstance(document.getElementById('modalTrans')).hide();
            document.getElementById('tDesc').value=""; document.getElementById('tVal').value=""; document.getElementById('tKm').value=""; document.getElementById('tLitros').value="";
            atualizarTela();
        }
        async function delTrans(id) { if(confirm("Apagar?")) { await fetch(`${API}/transacoes/${id}`, {method:"DELETE"}); atualizarTela(); } }
        
        function abrirConfig() { loadFixas(); new bootstrap.Modal(document.getElementById('modalConfig')).show(); }
        async function loadFixas() {
            const res = await fetch(`${API}/negocios/${ATUAL_ID}/fixas`); const lista = await res.json();
            const ul = document.getElementById('listaFixas'); ul.innerHTML = "";
            lista.forEach(f => { ul.innerHTML += `<li class="list-group-item bg-dark border-secondary text-white d-flex justify-content-between align-items-center"><span>${f.nome} (R$${f.valor})</span><div><button onclick="pagarFixa(${f.id})" class="btn btn-sm btn-outline-success"><i class="bi bi-check2"></i></button><button onclick="delFixa(${f.id})" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button></div></li>`; });
        }
        async function criarFixa() { await fetch(`${API}/fixas`, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({nome:document.getElementById('fNome').value, valor:document.getElementById('fValor').value, negocio_id:ATUAL_ID})}); loadFixas(); }
        async function pagarFixa(id) { await fetch(`${API}/fixas/${id}/pagar`, {method:"POST"}); alert("Pago!"); loadFixas(); atualizarTela(); }
        async function delFixa(id) { await fetch(`${API}/fixas/${id}`, {method:"DELETE"}); loadFixas(); }
        async function deletarNegocio() { if(confirm("Apagar carteira?")) { await fetch(`${API}/negocios/${ATUAL_ID}`, {method:"DELETE"}); voltarHome(); } }
        function voltarHome() { document.getElementById('viewDash').style.display='none'; carregarHome(); }

        carregarHome();
    </script>
</body>
</html>